name: Integration Tests - Ruby

on:
  workflow_call:
    inputs:
      version1:
        description: 'First Ruby version to test'
        required: false
        type: string
        default: '3.3.6'
      version2:
        description: 'Second Ruby version to test'
        required: false
        type: string
        default: '3.4.1'
  workflow_dispatch:
    inputs:
      version1:
        description: 'First Ruby version to test'
        required: false
        type: string
        default: '3.3.6'
      version2:
        description: 'Second Ruby version to test'
        required: false
        type: string
        default: '3.4.1'

permissions:
  contents: read

jobs:
  integration-test-ruby:
    name: Ruby (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            ext: ""
            # Ubuntu uses older Ruby versions available in ruby-builder for ubuntu-22.04
            version1: "3.2.2"
            version2: "3.2.3"
          - os: macos-latest
            platform: macos
            ext: ""
            version1: "3.3.6"
            version2: "3.4.1"
          - os: windows-latest
            platform: windows
            ext: ".exe"
            version1: "3.3.6"
            version2: "3.4.1"
    env:
      # Run tests from a directory outside the repo to avoid picking up .dtvem/runtimes.json
      TEST_WORKSPACE: ${{ github.workspace }}/../dtvem-test-workspace

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Build dtvem
        run: |
          go build -v -ldflags="-s -w" -o dist/dtvem${{ matrix.ext }} ./src
          go build -v -ldflags="-s -w" -o dist/dtvem-shim${{ matrix.ext }} ./src/cmd/shim
        shell: bash

      - name: Initialize dtvem
        run: |
          ./dist/dtvem${{ matrix.ext }} init --yes
        shell: bash

      - name: Add shims to PATH (Unix)
        if: matrix.platform != 'windows'
        run: |
          # Linux uses XDG path (~/.local/share/dtvem), macOS uses ~/.dtvem
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            DTVEM_ROOT="${XDG_DATA_HOME:-$HOME/.local/share}/dtvem"
          else
            DTVEM_ROOT="$HOME/.dtvem"
          fi
          echo "$DTVEM_ROOT/shims" >> $GITHUB_PATH
          echo "$DTVEM_ROOT/bin" >> $GITHUB_PATH

      - name: Add shims to PATH (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          "$env:USERPROFILE\.dtvem\shims" | Out-File -FilePath $env:GITHUB_PATH -Append
          "$env:USERPROFILE\.dtvem\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Set up test workspace
        run: |
          mkdir -p "$TEST_WORKSPACE"
          cp ./dist/dtvem${{ matrix.ext }} "$TEST_WORKSPACE/"
          cp ./dist/dtvem-shim${{ matrix.ext }} "$TEST_WORKSPACE/"
        shell: bash

      - name: "List available versions and verify test versions exist"
        run: |
          cd "$TEST_WORKSPACE"
          echo "## Ruby Available Versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          AVAILABLE=$(./dtvem${{ matrix.ext }} list-all ruby)
          echo "$AVAILABLE" | head -20 >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify test versions are available
          echo "Verifying test versions are available..."
          if ! echo "$AVAILABLE" | grep -q "${{ matrix.version1 }}"; then
            echo "ERROR: Version ${{ matrix.version1 }} not found in available versions"
            echo "Available versions:"
            echo "$AVAILABLE"
            exit 1
          fi
          if ! echo "$AVAILABLE" | grep -q "${{ matrix.version2 }}"; then
            echo "ERROR: Version ${{ matrix.version2 }} not found in available versions"
            echo "Available versions:"
            echo "$AVAILABLE"
            exit 1
          fi
          echo "✓ Both versions ${{ matrix.version1 }} and ${{ matrix.version2 }} are available"
        shell: bash

      - name: "Install version ${{ matrix.version1 }}"
        run: |
          cd "$TEST_WORKSPACE"
          ./dtvem${{ matrix.ext }} install ruby ${{ matrix.version1 }}
        shell: bash

      - name: "Install version ${{ matrix.version2 }}"
        run: |
          cd "$TEST_WORKSPACE"
          ./dtvem${{ matrix.ext }} install ruby ${{ matrix.version2 }}
        shell: bash

      - name: "List installed versions"
        run: |
          cd "$TEST_WORKSPACE"
          echo "## Ruby Installed Versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./dtvem${{ matrix.ext }} list ruby >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: "Set global version to ${{ matrix.version1 }}"
        run: |
          cd "$TEST_WORKSPACE"
          ./dtvem${{ matrix.ext }} global ruby ${{ matrix.version1 }}
        shell: bash

      - name: "Verify global version via current"
        run: |
          cd "$TEST_WORKSPACE"
          CURRENT=$(./dtvem${{ matrix.ext }} current ruby --no-install)
          echo "Current ruby version: $CURRENT"
          if [[ "$CURRENT" != *"${{ matrix.version1 }}"* ]]; then
            echo "ERROR: Expected ${{ matrix.version1 }} but got $CURRENT"
            exit 1
          fi
        shell: bash

      - name: "Verify shim works (ruby --version)"
        run: |
          cd "$TEST_WORKSPACE"
          RUBY_VERSION=$(ruby --version)
          echo "Ruby version from shim: $RUBY_VERSION"
          if [[ "$RUBY_VERSION" != *"${{ matrix.version1 }}"* ]]; then
            echo "ERROR: Expected ruby ${{ matrix.version1 }} but got $RUBY_VERSION"
            exit 1
          fi
        shell: bash

      - name: "Switch global version to ${{ matrix.version2 }}"
        run: |
          cd "$TEST_WORKSPACE"
          ./dtvem${{ matrix.ext }} global ruby ${{ matrix.version2 }}
        shell: bash

      - name: "Verify version switched"
        run: |
          cd "$TEST_WORKSPACE"
          RUBY_VERSION=$(ruby --version)
          echo "Ruby version from shim: $RUBY_VERSION"
          if [[ "$RUBY_VERSION" != *"${{ matrix.version2 }}"* ]]; then
            echo "ERROR: Expected ruby ${{ matrix.version2 }} but got $RUBY_VERSION"
            exit 1
          fi
        shell: bash

      - name: "Test local version override"
        run: |
          cd "$TEST_WORKSPACE"
          mkdir -p test-project
          cd test-project
          ../dtvem${{ matrix.ext }} local ruby ${{ matrix.version1 }}
          CURRENT=$(../dtvem${{ matrix.ext }} current ruby --no-install)
          echo "Current ruby version in test-project: $CURRENT"
          if [[ "$CURRENT" != *"${{ matrix.version1 }}"* ]]; then
            echo "ERROR: Local override failed. Expected ${{ matrix.version1 }} but got $CURRENT"
            exit 1
          fi
          RUBY_VERSION=$(ruby --version)
          echo "Ruby version from shim in test-project: $RUBY_VERSION"
          if [[ "$RUBY_VERSION" != *"${{ matrix.version1 }}"* ]]; then
            echo "ERROR: Expected ruby ${{ matrix.version1 }} but got $RUBY_VERSION"
            exit 1
          fi
        shell: bash

      - name: "Test which command"
        run: |
          cd "$TEST_WORKSPACE"
          echo "## Ruby Which" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./dtvem${{ matrix.ext }} which ruby >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: "Test where command"
        run: |
          cd "$TEST_WORKSPACE"
          echo "## Ruby Where" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./dtvem${{ matrix.ext }} where ruby >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: "Test reshim command"
        run: |
          cd "$TEST_WORKSPACE"
          ./dtvem${{ matrix.ext }} reshim
          echo "Reshim completed successfully"
        shell: bash

      - name: "Test freeze command"
        run: |
          cd "$TEST_WORKSPACE"
          echo "## Freeze Output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./dtvem${{ matrix.ext }} freeze >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: "Switch global back to ${{ matrix.version1 }} before uninstall"
        run: |
          cd "$TEST_WORKSPACE"
          ./dtvem${{ matrix.ext }} global ruby ${{ matrix.version1 }}
        shell: bash

      - name: "Uninstall version ${{ matrix.version2 }}"
        run: |
          cd "$TEST_WORKSPACE"
          ./dtvem${{ matrix.ext }} uninstall ruby ${{ matrix.version2 }} --yes
        shell: bash

      - name: "Verify uninstall"
        run: |
          cd "$TEST_WORKSPACE"
          LIST_OUTPUT=$(./dtvem${{ matrix.ext }} list ruby)
          echo "Installed versions after uninstall:"
          echo "$LIST_OUTPUT"
          if [[ "$LIST_OUTPUT" == *"${{ matrix.version2 }}"* ]]; then
            echo "ERROR: Version ${{ matrix.version2 }} should have been uninstalled"
            exit 1
          fi
        shell: bash

      - name: Generate summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Ruby Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Command | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| list-all | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| install | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| list | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| global | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| current | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| shim execution | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| local override | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| which | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| where | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| reshim | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| freeze | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| uninstall | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Platform: **${{ matrix.platform }}** (${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
        shell: bash
