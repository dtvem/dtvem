name: Mirror All Binaries

on:
  workflow_dispatch:
    inputs:
      runtime:
        description: 'Runtime to mirror (node, python, ruby, or all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - node
          - python
          - ruby
      dry_run:
        description: 'Dry run (report only, no uploads)'
        required: false
        default: false
        type: boolean

jobs:
  mirror:
    name: Mirror ${{ matrix.runtime }}
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    strategy:
      fail-fast: false
      matrix:
        runtime: ${{ inputs.runtime == 'all' && fromJson('["node", "python", "ruby"]') || fromJson(format('["{0}"]', inputs.runtime)) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Build mirror tool
        run: |
          cd scripts/mirror-binaries
          go build -o mirror-binaries .

      - name: Mirror binaries (dry run)
        if: inputs.dry_run
        run: |
          ./scripts/mirror-binaries/mirror-binaries \
            --runtime=${{ matrix.runtime }} \
            --manifest-dir=src/internal/manifest/data \
            --dry-run

      - name: Mirror binaries
        if: ${{ !inputs.dry_run }}
        env:
          R2_ENDPOINT: https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
          R2_BUCKET: ${{ secrets.CLOUDFLARE_R2_BUILDS_BUCKET }}
          R2_ACCESS_KEY: ${{ secrets.CLOUDFLARE_R2_ACCESS_KEY_ID }}
          R2_SECRET_KEY: ${{ secrets.CLOUDFLARE_R2_SECRET_ACCESS_KEY }}
        run: |
          ./scripts/mirror-binaries/mirror-binaries \
            --runtime=${{ matrix.runtime }} \
            --manifest-dir=src/internal/manifest/data \
            --r2-endpoint="$R2_ENDPOINT" \
            --r2-bucket="$R2_BUCKET" \
            --r2-access-key="$R2_ACCESS_KEY" \
            --r2-secret-key="$R2_SECRET_KEY" \
            --workers=20

      - name: Generate summary
        if: always()
        run: |
          echo "## Mirror Results for ${{ matrix.runtime }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "**Mode:** Dry run (no uploads)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** Live upload to R2" >> $GITHUB_STEP_SUMMARY
          fi
