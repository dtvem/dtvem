name: Integration Tests - Migrate Node.js from nvm-windows (Windows)

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  migrate:
    name: Node.js from nvm-windows (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Build dtvem
        shell: bash
        run: |
          go build -v -ldflags="-s -w" -o dist/dtvem.exe ./src
          go build -v -ldflags="-s -w" -o dist/dtvem-shim.exe ./src/cmd/shim

      - name: Initialize dtvem
        shell: bash
        run: ./dist/dtvem.exe init --yes

      - name: Add dtvem to PATH
        shell: pwsh
        run: |
          "$env:USERPROFILE\.dtvem\shims" | Out-File -FilePath $env:GITHUB_PATH -Append
          "$env:USERPROFILE\.dtvem\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: "Install nvm-windows"
        shell: pwsh
        run: |
          # Manual installation of nvm-windows (Chocolatey's async installer doesn't work in CI)
          $nvmVersion = "1.2.2"
          $nvmHome = "$env:USERPROFILE\AppData\Roaming\nvm"
          $nvmSymlink = "$env:USERPROFILE\AppData\Roaming\nodejs"

          # Create directories
          New-Item -ItemType Directory -Force -Path $nvmHome | Out-Null
          New-Item -ItemType Directory -Force -Path $nvmSymlink | Out-Null

          # Download nvm-windows noinstall zip
          $nvmZip = "$env:TEMP\nvm-noinstall.zip"
          Invoke-WebRequest -Uri "https://github.com/coreybutler/nvm-windows/releases/download/$nvmVersion/nvm-noinstall.zip" -OutFile $nvmZip

          # Extract to NVM_HOME
          Expand-Archive -Path $nvmZip -DestinationPath $nvmHome -Force

          # Create settings.txt
          $settings = @"
          root: $nvmHome
          path: $nvmSymlink
          proxy: none
          "@
          $settings | Out-File -FilePath "$nvmHome\settings.txt" -Encoding UTF8

          # Export environment variables for subsequent steps
          "NVM_HOME=$nvmHome" | Out-File -FilePath $env:GITHUB_ENV -Append
          "NVM_SYMLINK=$nvmSymlink" | Out-File -FilePath $env:GITHUB_ENV -Append

          # Add to PATH for subsequent steps
          "$nvmHome" | Out-File -FilePath $env:GITHUB_PATH -Append
          "$nvmSymlink" | Out-File -FilePath $env:GITHUB_PATH -Append

          Write-Host "NVM_HOME: $nvmHome"
          Write-Host "NVM_SYMLINK: $nvmSymlink"
          Write-Host "nvm.exe exists: $(Test-Path "$nvmHome\nvm.exe")"

      - name: "Install Node.js 20.18.0 via nvm-windows"
        shell: pwsh
        run: |
          Write-Host "NVM_HOME: $env:NVM_HOME"
          Write-Host "nvm.exe path: $env:NVM_HOME\nvm.exe"
          & "$env:NVM_HOME\nvm.exe" install 20.18.0
          & "$env:NVM_HOME\nvm.exe" use 20.18.0
          Write-Host "nvm-windows Node.js version:"
          node --version

      - name: "Migrate nvm-windows Node.js to dtvem"
        shell: bash
        run: |
          echo "=== Running migrate detection ==="
          # Select "all" to migrate all detected versions (system + nvm)
          echo -e "all\n0\nn\n" | ./dist/dtvem.exe migrate node || true
          echo ""
          echo "=== Verifying migration ==="
          ./dist/dtvem.exe list node

      - name: "Verify migrated version"
        shell: bash
        run: |
          ./dist/dtvem.exe list node | grep -E "20\.18\.0" || (echo "ERROR: Expected Node.js 20.18.0 to be migrated" && exit 1)
          echo "SUCCESS: Node.js 20.18.0 was migrated from nvm-windows"

      - name: Generate summary
        if: always()
        shell: bash
        run: |
          echo "## Node.js Migration from nvm-windows (Windows)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** nvm-windows" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** 20.18.0" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installed Versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./dist/dtvem.exe list node >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
