name: Integration Tests - Migrate Python from pyenv-win (Windows)

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  migrate:
    name: Python from pyenv-win (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Build dtvem
        shell: bash
        run: |
          go build -v -ldflags="-s -w" -o dist/dtvem.exe ./src
          go build -v -ldflags="-s -w" -o dist/dtvem-shim.exe ./src/cmd/shim

      - name: Initialize dtvem
        shell: bash
        run: ./dist/dtvem.exe init --yes

      - name: Add dtvem to PATH
        shell: pwsh
        run: |
          "$env:USERPROFILE\.dtvem\shims" | Out-File -FilePath $env:GITHUB_PATH -Append
          "$env:USERPROFILE\.dtvem\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: "Install pyenv-win"
        shell: pwsh
        run: |
          pip install pyenv-win --target "$env:USERPROFILE\.pyenv"
          [System.Environment]::SetEnvironmentVariable('PYENV', "$env:USERPROFILE\.pyenv\pyenv-win\", "User")
          [System.Environment]::SetEnvironmentVariable('PYENV_ROOT', "$env:USERPROFILE\.pyenv\pyenv-win\", "User")
          [System.Environment]::SetEnvironmentVariable('PYENV_HOME', "$env:USERPROFILE\.pyenv\pyenv-win\", "User")
          "$env:USERPROFILE\.pyenv\pyenv-win\bin" | Out-File -FilePath $env:GITHUB_PATH -Append
          "$env:USERPROFILE\.pyenv\pyenv-win\shims" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: "Find and install available Python 3.11.x via pyenv-win"
        id: install-python
        shell: pwsh
        run: |
          $env:Path = "$env:USERPROFILE\.pyenv\pyenv-win\bin;$env:USERPROFILE\.pyenv\pyenv-win\shims;$env:Path"

          # List available versions and find latest 3.11.x (non-dev, non-rc)
          Write-Host "Available Python 3.11.x versions:"
          $versions = pyenv install -l | Select-String "^\s*3\.11\.\d+$" | ForEach-Object { $_.Line.Trim() }
          $versions | ForEach-Object { Write-Host "  $_" }

          # Get the latest 3.11.x version (last one in sorted list)
          $latestVersion = $versions | Sort-Object { [version]$_ } | Select-Object -Last 1
          Write-Host "Installing Python $latestVersion"

          pyenv install $latestVersion
          pyenv global $latestVersion
          pyenv rehash

          Write-Host "pyenv-win Python version:"
          python --version

          # Output the version for later steps
          "PYTHON_VERSION=$latestVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: "Migrate pyenv-win Python to dtvem"
        shell: bash
        run: |
          echo "=== Running migrate detection ==="
          # Select "all" to migrate all detected versions
          echo -e "all\n0\nn\n" | ./dist/dtvem.exe migrate python || true
          echo ""
          echo "=== Verifying migration ==="
          ./dist/dtvem.exe list python

      - name: "Verify migrated version"
        shell: bash
        env:
          EXPECTED_VERSION: ${{ steps.install-python.outputs.PYTHON_VERSION }}
        run: |
          echo "Looking for Python $EXPECTED_VERSION"
          ./dist/dtvem.exe list python | grep -E "$EXPECTED_VERSION" || (echo "ERROR: Expected Python $EXPECTED_VERSION to be migrated" && exit 1)
          echo "SUCCESS: Python $EXPECTED_VERSION was migrated from pyenv-win"

      - name: Generate summary
        if: always()
        shell: bash
        env:
          EXPECTED_VERSION: ${{ steps.install-python.outputs.PYTHON_VERSION }}
        run: |
          echo "## Python Migration from pyenv-win (Windows)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** pyenv-win" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $EXPECTED_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installed Versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./dist/dtvem.exe list python >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
