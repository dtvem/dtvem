name: Integration Tests - Python

on:
  workflow_call:
    inputs:
      version1:
        description: 'First Python version to test'
        required: false
        type: string
        default: '3.11.9'
      version2:
        description: 'Second Python version to test'
        required: false
        type: string
        default: '3.12.7'
  workflow_dispatch:
    inputs:
      version1:
        description: 'First Python version to test'
        required: false
        type: string
        default: '3.11.9'
      version2:
        description: 'Second Python version to test'
        required: false
        type: string
        default: '3.12.7'

permissions:
  contents: read

jobs:
  integration-test-python:
    name: Python (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            ext: ""
            # Use Python versions available in both python.org and python-build-standalone (20240814)
            version1: "3.11.9"
            version2: "3.12.5"
          - os: macos-latest
            platform: macos
            ext: ""
            version1: "3.11.9"
            version2: "3.12.5"
          - os: windows-latest
            platform: windows
            ext: ".exe"
            version1: "3.11.9"
            version2: "3.12.5"
    env:
      # Run tests from a directory outside the repo to avoid picking up .dtvem/runtimes.json
      TEST_WORKSPACE: ${{ github.workspace }}/../dtvem-test-workspace

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Build dtvem
        run: |
          go build -v -ldflags="-s -w" -o dist/dtvem${{ matrix.ext }} ./src
          go build -v -ldflags="-s -w" -o dist/dtvem-shim${{ matrix.ext }} ./src/cmd/shim
        shell: bash

      - name: Initialize dtvem
        run: |
          ./dist/dtvem${{ matrix.ext }} init --yes
        shell: bash

      - name: Add shims to PATH (Unix)
        if: matrix.platform != 'windows'
        run: |
          # Linux uses XDG path (~/.local/share/dtvem), macOS uses ~/.dtvem
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            DTVEM_ROOT="${XDG_DATA_HOME:-$HOME/.local/share}/dtvem"
          else
            DTVEM_ROOT="$HOME/.dtvem"
          fi
          echo "$DTVEM_ROOT/shims" >> $GITHUB_PATH
          echo "$DTVEM_ROOT/bin" >> $GITHUB_PATH

      - name: Add shims to PATH (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          "$env:USERPROFILE\.dtvem\shims" | Out-File -FilePath $env:GITHUB_PATH -Append
          "$env:USERPROFILE\.dtvem\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Set up test workspace
        run: |
          mkdir -p "$TEST_WORKSPACE"
          cp ./dist/dtvem${{ matrix.ext }} "$TEST_WORKSPACE/"
          cp ./dist/dtvem-shim${{ matrix.ext }} "$TEST_WORKSPACE/"
        shell: bash

      - name: "List available versions and verify test versions exist"
        run: |
          cd "$TEST_WORKSPACE"
          echo "## Python Available Versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./dtvem${{ matrix.ext }} list-all python | head -20 >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify test versions are available using --filter and stripping ANSI codes
          echo "Verifying test versions are available..."

          # Check version1
          FILTERED=$(./dtvem${{ matrix.ext }} list-all python --filter "${{ matrix.version1 }}" 2>&1 | sed 's/\x1B\[[0-9;]*[a-zA-Z]//g')
          if ! echo "$FILTERED" | grep -qF "${{ matrix.version1 }}"; then
            echo "ERROR: Version ${{ matrix.version1 }} not found in available versions"
            echo "Filtered output: $FILTERED"
            exit 1
          fi
          echo "✓ Version ${{ matrix.version1 }} is available"

          # Check version2
          FILTERED=$(./dtvem${{ matrix.ext }} list-all python --filter "${{ matrix.version2 }}" 2>&1 | sed 's/\x1B\[[0-9;]*[a-zA-Z]//g')
          if ! echo "$FILTERED" | grep -qF "${{ matrix.version2 }}"; then
            echo "ERROR: Version ${{ matrix.version2 }} not found in available versions"
            echo "Filtered output: $FILTERED"
            exit 1
          fi
          echo "✓ Version ${{ matrix.version2 }} is available"

          echo "✓ Both versions ${{ matrix.version1 }} and ${{ matrix.version2 }} are available"
        shell: bash

      - name: "Install version ${{ matrix.version1 }}"
        run: |
          cd "$TEST_WORKSPACE"
          ./dtvem${{ matrix.ext }} install python ${{ matrix.version1 }}
        shell: bash

      - name: "Install version ${{ matrix.version2 }}"
        run: |
          cd "$TEST_WORKSPACE"
          ./dtvem${{ matrix.ext }} install python ${{ matrix.version2 }}
        shell: bash

      - name: "List installed versions"
        run: |
          cd "$TEST_WORKSPACE"
          echo "## Python Installed Versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./dtvem${{ matrix.ext }} list python >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: "Set global version to ${{ matrix.version1 }}"
        run: |
          cd "$TEST_WORKSPACE"
          ./dtvem${{ matrix.ext }} global python ${{ matrix.version1 }}
        shell: bash

      - name: "Verify global version via current"
        run: |
          cd "$TEST_WORKSPACE"
          CURRENT=$(./dtvem${{ matrix.ext }} current python --no-install)
          echo "Current python version: $CURRENT"
          if [[ "$CURRENT" != *"${{ matrix.version1 }}"* ]]; then
            echo "ERROR: Expected ${{ matrix.version1 }} but got $CURRENT"
            exit 1
          fi
        shell: bash

      - name: "Verify shim works (python --version)"
        run: |
          cd "$TEST_WORKSPACE"
          PYTHON_VERSION=$(python --version)
          echo "Python version from shim: $PYTHON_VERSION"
          if [[ "$PYTHON_VERSION" != *"${{ matrix.version1 }}"* ]]; then
            echo "ERROR: Expected Python ${{ matrix.version1 }} but got $PYTHON_VERSION"
            exit 1
          fi
        shell: bash

      - name: "Switch global version to ${{ matrix.version2 }}"
        run: |
          cd "$TEST_WORKSPACE"
          ./dtvem${{ matrix.ext }} global python ${{ matrix.version2 }}
        shell: bash

      - name: "Verify version switched"
        run: |
          cd "$TEST_WORKSPACE"
          PYTHON_VERSION=$(python --version)
          echo "Python version from shim: $PYTHON_VERSION"
          if [[ "$PYTHON_VERSION" != *"${{ matrix.version2 }}"* ]]; then
            echo "ERROR: Expected Python ${{ matrix.version2 }} but got $PYTHON_VERSION"
            exit 1
          fi
        shell: bash

      - name: "Test local version override"
        run: |
          cd "$TEST_WORKSPACE"
          mkdir -p test-project
          cd test-project
          ../dtvem${{ matrix.ext }} local python ${{ matrix.version1 }}
          CURRENT=$(../dtvem${{ matrix.ext }} current python --no-install)
          echo "Current python version in test-project: $CURRENT"
          if [[ "$CURRENT" != *"${{ matrix.version1 }}"* ]]; then
            echo "ERROR: Local override failed. Expected ${{ matrix.version1 }} but got $CURRENT"
            exit 1
          fi
          PYTHON_VERSION=$(python --version)
          echo "Python version from shim in test-project: $PYTHON_VERSION"
          if [[ "$PYTHON_VERSION" != *"${{ matrix.version1 }}"* ]]; then
            echo "ERROR: Expected Python ${{ matrix.version1 }} but got $PYTHON_VERSION"
            exit 1
          fi
        shell: bash

      - name: "Test which command"
        run: |
          cd "$TEST_WORKSPACE"
          echo "## Python Which" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./dtvem${{ matrix.ext }} which python >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: "Test where command"
        run: |
          cd "$TEST_WORKSPACE"
          echo "## Python Where" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./dtvem${{ matrix.ext }} where python >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: "Test reshim command"
        run: |
          cd "$TEST_WORKSPACE"
          ./dtvem${{ matrix.ext }} reshim
          echo "Reshim completed successfully"
        shell: bash

      - name: "Test freeze command"
        run: |
          cd "$TEST_WORKSPACE"
          echo "## Freeze Output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./dtvem${{ matrix.ext }} freeze >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: "Switch global back to ${{ matrix.version1 }} before uninstall"
        run: |
          cd "$TEST_WORKSPACE"
          ./dtvem${{ matrix.ext }} global python ${{ matrix.version1 }}
        shell: bash

      - name: "Uninstall version ${{ matrix.version2 }}"
        run: |
          cd "$TEST_WORKSPACE"
          ./dtvem${{ matrix.ext }} uninstall python ${{ matrix.version2 }} --yes
        shell: bash

      - name: "Verify uninstall"
        run: |
          cd "$TEST_WORKSPACE"
          LIST_OUTPUT=$(./dtvem${{ matrix.ext }} list python)
          echo "Installed versions after uninstall:"
          echo "$LIST_OUTPUT"
          if [[ "$LIST_OUTPUT" == *"${{ matrix.version2 }}"* ]]; then
            echo "ERROR: Version ${{ matrix.version2 }} should have been uninstalled"
            exit 1
          fi
        shell: bash

      - name: Generate summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Python Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Command | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| list-all | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| install | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| list | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| global | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| current | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| shim execution | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| local override | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| which | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| where | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| reshim | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| freeze | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| uninstall | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Platform: **${{ matrix.platform }}** (${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
        shell: bash
