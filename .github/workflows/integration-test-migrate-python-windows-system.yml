name: Integration Tests - Migrate Python from System (Windows)

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  migrate:
    name: Python from System (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      # Install a Python version that's available in our manifest for Windows
      # python-build-standalone only has Windows builds starting from 3.10.14
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Build dtvem
        shell: bash
        run: |
          go build -v -ldflags="-s -w" -o dist/dtvem.exe ./src
          go build -v -ldflags="-s -w" -o dist/dtvem-shim.exe ./src/cmd/shim

      - name: Initialize dtvem
        shell: bash
        run: ./dist/dtvem.exe init --yes

      - name: Add dtvem to PATH
        shell: pwsh
        run: |
          "$env:USERPROFILE\.dtvem\shims" | Out-File -FilePath $env:GITHUB_PATH -Append
          "$env:USERPROFILE\.dtvem\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: "Detect pre-installed Python version"
        id: detect-python
        shell: pwsh
        run: |
          # GitHub runners have Python pre-installed, use that version
          $pythonVersion = python --version 2>&1
          Write-Host "Pre-installed Python: $pythonVersion"
          # Extract version number (e.g., "3.9.13" from "Python 3.9.13")
          if ($pythonVersion -match "Python (\d+\.\d+\.\d+)") {
            $version = $Matches[1]
            Write-Host "Detected version: $version"
            "PYTHON_VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            Write-Host "ERROR: Could not detect Python version"
            exit 1
          }

      - name: "Migrate system Python to dtvem"
        shell: bash
        run: |
          echo "=== Running migrate detection ==="
          # Select "all" to migrate all detected versions
          echo -e "all\n0\n" | ./dist/dtvem.exe migrate python || true
          echo ""
          echo "=== Verifying migration ==="
          ./dist/dtvem.exe list python

      - name: "Verify migrated version"
        shell: bash
        env:
          EXPECTED_VERSION: ${{ steps.detect-python.outputs.PYTHON_VERSION }}
        run: |
          # Extract major.minor from detected version (e.g., "3.9" from "3.9.13")
          MAJOR_MINOR=$(echo "$EXPECTED_VERSION" | cut -d. -f1,2)
          echo "Looking for Python $MAJOR_MINOR.x"
          ./dist/dtvem.exe list python | grep -E "${MAJOR_MINOR}\." || (echo "ERROR: Expected Python ${MAJOR_MINOR}.x to be migrated" && exit 1)
          echo "SUCCESS: Python ${MAJOR_MINOR}.x was migrated from system"

      - name: Generate summary
        if: always()
        shell: bash
        env:
          EXPECTED_VERSION: ${{ steps.detect-python.outputs.PYTHON_VERSION }}
        run: |
          echo "## Python Migration from System (Windows)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** Pre-installed (GitHub Runner)" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $EXPECTED_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installed Versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./dist/dtvem.exe list python >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
